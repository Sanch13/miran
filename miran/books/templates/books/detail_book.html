{% extends 'users/base.html' %}
{% load static %}

{% block title %}
<title>{{ book.author }} - {{ book.title }}</title>
{% endblock title %}

{% block content %}

{% if messages %}
{% for message in messages %}
<div class="container-fluid p-0">
    <div class="alert">
        {{ message }}
    </div>
</div>
{% endfor %}
{% endif %}


<div class="row py-1">
    <div class="col-12 py-2">
        <h2 class="text-center">{{ book.title }}</h2>
    </div>
    <div class="col-lg-3">
        <div style="text-align: center">
            <p class="my-0">QR-code книги: </p>
            <img src="{{ book.qr_code.url }}" width="200" height="200">
        </div>
    </div>
    <div class="col-lg-9">
        <div class="row">
            <div class="col-2">
                <p>Автор книги: </p>
            </div>
            <div class="col-10">
                <p><b>{{ book.author }}</b></p>
            </div>
        </div>
        <div class="row">
            <div class="col-2">
                <p>Дата издания: </p>
            </div>
            <div class="col-10">
                <p><b>{{ book.year }}</b></p>
            </div>
        </div>
<!--        <div class="row">-->
<!--            <div class="col-2">-->
<!--                <p>Название книги: </p>-->
<!--            </div>-->
<!--            <div class="col-10">-->
<!--                <p><b>{{ book.title }}</b></p>-->
<!--            </div>-->
<!--        </div>-->
        <div class="row">
            <div class="col-2">
                <p>Краткое описание книги: </p>
            </div>
            <div class="col-10">
                <p><i><b>{{ book.description }}</b></i></p>
            </div>
        </div>
        <div class="row">
            <div class="col-2">
                <p>Статус книги: </p>
            </div>
            <div class="col-10">
                <p><b>{{ book.status }}</b></p>
            </div>
        </div>
        <div class="row">
            <div class="col-2">
                {% if reader %}
                <p>Книгу взял в пользование:</p>
                {% endif %}
            </div>
            <div class="col-10">
                <p><b>{{ reader }} </b></p>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid p-2">
    <div class="text-center">
        {% if book.status == 'CLOSE' %}
        {% if reader.user_id == user.id %}
        <form method="post" action="{% url 'books:return_book' %}">
            {% csrf_token %}
            <input type="hidden" name="slug" value="{{ book.slug }}">
            {{ form.as_p }}
            <button type="submit" class="btn btn-miran">Вернуть книгу в библиотеку</button>
        </form>
        {% endif %}
        {% else %}
        {% if user.is_authenticated %}
        <form method="post" action="{% url 'books:reg_book' %}">
            {% csrf_token %}
            <input type="hidden" name="slug" value="{{ book.slug }}">
            {{ form.as_p }}
            <button type="submit" class="btn btn-miran">Взять книгу в пользование</button>
        </form>
        {% else %}
        <p>Только зарегистрированные пользователи могут брать книгу. <a
                href="{% url 'users:login' %}">Войти</a>
        </p>
        {% endif %}
        {% endif %}
    </div>
</div>

<h3 style="text-align: center">История книги</h3>
<div>
    <table class="table table-bordered">
        <thead class="table-secondary">
        <th class="text-center align-bottom">Номер</th>
        <th class="text-center align-bottom">Пользователь</th>
        <th class="text-center align-bottom">Дата взятия</th>
        <th class="text-center align-bottom">Дата возврата</th>
        </thead>
        <tbody>
        {% for book in book_history %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ book }}</td>
                <td>{{ book.date_start }}</td>
                <td>{{ book.date_end }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<script>
    function showMessage(message) {
        const popup = document.getElementById("popup");
        const popupMessage = document.querySelector(".popup-message");
        popupMessage.textContent = message;
        popup.style.display = "block";
        popup.style.opacity = 1;

        setTimeout(function () {
            let opacity = 1;
            const fadeOutInterval = setInterval(function () {
                if (opacity <= 0) {
                    clearInterval(fadeOutInterval);
                    popup.style.display = "none";
                } else {
                    opacity -= 0.05;
                    popup.style.opacity = opacity;
                }
            }, 100);
        }, 5000);  // Скрыть сообщение через 5 секунд
    }

    // Вызов функции с сообщением
    {%
        if messages %}
    {%
        for message in messages %}
    showMessage("{{ message }}");
    {%
        endfor %
    }
    {%
        endif %
    }

</script>
{% endblock content %}
