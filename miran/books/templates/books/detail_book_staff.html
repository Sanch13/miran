{% extends 'users/base.html' %}
{% load static %}

{% block title %}
<title>{{ book.author }} - {{ book.title }}</title>
{% endblock title %}

{% block content %}

<nav aria-label="breadcrumb">
    <ol class="breadcrumb my-1">
        <!--    <li class="breadcrumb-item"><a href="#">Главная</a></li>-->
        <li class="breadcrumb-item"><a href="{% url 'books:book_list_card' %}">Список книг</a></li>
<!--        <li class="breadcrumb-item active" aria-current="page">{{ book.title }}</li>-->
    </ol>
</nav>

<div class="row py-1">
    <div class="col-12 py-2">
        <h2 class="text-center">{{ book.title }}</h2>
    </div>
    <div class="col-lg-3">
        <div style="text-align: center">
            <p class="my-0">QR-code книги: </p>
            <img src="{{ book.qr_code.url }}"
                 id="printableImage"
                 width="200"
                 height="200"
                 style="max-width: 100%;"
                 alt="QR-code"
            >
            <div>
                {% if request.user.is_staff %}
                <a href="#" onclick="printImage()">Напечатать QR-code</a>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-lg-9">
        <div class="row">
            <div class="col-3 p-1 mb-1">
                Автор книги:
            </div>
            <div class="col-9 p-1 mb-1">
                <b>{{ book.author }}</b>
            </div>
        </div>
        <div class="row">
            <div class="col-3 p-1 mb-1">
                Дата издания:
            </div>
            <div class="col-9 p-1 mb-1">
                <b>{{ book.year }}</b>
            </div>
        </div>
        <div class="row">
            <div class="col-3 p-1 mb-1">
                Краткое описание книги:
            </div>
            <div class="col-9 p-1 mb-1">
                <i><b>{{ book.description }}</b></i>
            </div>
        </div>
        <div class="row">
            <div class="col-3 p-1 mb-1">
                Статус книги:
            </div>
            <div class="col-9 p-1 mb-1">
                <b>{% if book.status == 'CLOSE' %}В пользовании{%else%} Свободна {%endif%}</b>
            </div>
        </div>
        <div class="row">
            <div class="col-3 p-1 mb-1">
                История книги:
            </div>
            <div class="col-9 p-1 mb-1">
                <a id="toggleLink" onclick="toggle_table()" href="#HistoryTable">Показать</a>
            </div>
        </div>
        <div class="row">
            <div class="col-3 p-1 mb-1">
                {% if reader %}
                Книгу взял в пользование:
                {% endif %}
            </div>
            <div class="col-9 p-1 mb-1">
                <b>{{ reader }} </b>
            </div>
        </div>
    </div>
</div>


<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 10; margin-bottom: 50px;">
    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-success text-center" id="message">
        {{ message }}
        <span id="countdown"></span>
    </div>
    {% endfor %}
    {% endif %}
</div>


<div class="container-fluid p-2">
    <div class="text-center">
        {% if book.status == 'CLOSE' %}
        {% if reader.user_id == user.id %}
        <form method="post" action="{% url 'books:return_book' %}">
            {% csrf_token %}
            <input type="hidden" name="slug" value="{{ book.slug }}">
            {{ form.as_p }}
            <button type="submit" class="btn btn-miran">Вернуть книгу в библиотеку</button>
        </form>
        {% endif %}
        {% else %}
        {% if user.is_authenticated %}
        <form method="post" action="{% url 'books:get_book' %}">
            {% csrf_token %}
            <input type="hidden" name="slug" value="{{ book.slug }}">
            {{ form.as_p }}
            <button type="submit" class="btn btn-miran">Взять книгу в пользование</button>
        </form>
        {% else %}
        <p>Только зарегистрированные пользователи могут брать книгу. <a
                href="{% url 'users:login' %}">Войти</a>
        </p>
        {% endif %}
        {% endif %}
    </div>
</div>

<div class="container-fluid" id="bookHistoryTable" style="display: none">
    <h3 style="text-align: center">История прочтения книги</h3>
    <table class="table table-bordered">
        <thead class="table-secondary" style=" height: 50px;">
        <th class="text-center align-middle">Номер</th>
        <th class="text-center align-middle">Пользователь</th>
        <th class="text-center align-middle">Дата выдачи</th>
        <th class="text-center align-middle">Дата возврата</th>
        </thead>
        <tbody id="HistoryTable">
        {% for book in book_history %}
        <tr class="text-center">
            <td style="width: 100px;">{{ forloop.counter }}</td>
            <td>{{ book }}</td>
            <td>{{ book.date_start }}</td>
            <td> {% if book.date_end %} {{ book.date_end }} {% else %} {% endif %}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<script src="{% static 'js/hide_alert_msg.js' %}"></script>
<script src="{% static 'js/print_image.js' %}"></script>
<script src="{% static 'js/toggle_table.js' %}"></script>

{% endblock content %}
